define(["react","@grafana/ui","@grafana/runtime","@grafana/data","lodash"],(function(e,t,r,n,a){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=7)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t,r){"use strict";(function(e){var n=r(0),a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},l=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=void 0;u="undefined"!=typeof window?window:"undefined"!=typeof self?self:e;var c=null,d=null,f=u.clearTimeout,p=u.setTimeout,h=u.cancelAnimationFrame||u.mozCancelAnimationFrame||u.webkitCancelAnimationFrame,g=u.requestAnimationFrame||u.mozRequestAnimationFrame||u.webkitRequestAnimationFrame;function _(e){var t=void 0,r=void 0,n=void 0,a=void 0,i=void 0,o=void 0,s=void 0,l="undefined"!=typeof document&&document.attachEvent;if(!l){o=function(e){var t=e.__resizeTriggers__,r=t.firstElementChild,n=t.lastElementChild,a=r.firstElementChild;n.scrollLeft=n.scrollWidth,n.scrollTop=n.scrollHeight,a.style.width=r.offsetWidth+1+"px",a.style.height=r.offsetHeight+1+"px",r.scrollLeft=r.scrollWidth,r.scrollTop=r.scrollHeight},i=function(e){return e.offsetWidth!==e.__resizeLast__.width||e.offsetHeight!==e.__resizeLast__.height},s=function(e){if(!(e.target.className&&"function"==typeof e.target.className.indexOf&&e.target.className.indexOf("contract-trigger")<0&&e.target.className.indexOf("expand-trigger")<0)){var t=this;o(this),this.__resizeRAF__&&c(this.__resizeRAF__),this.__resizeRAF__=d((function(){i(t)&&(t.__resizeLast__.width=t.offsetWidth,t.__resizeLast__.height=t.offsetHeight,t.__resizeListeners__.forEach((function(r){r.call(t,e)})))}))}};var f=!1,p="";n="animationstart";var h="Webkit Moz O ms".split(" "),g="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),_=document.createElement("fakeelement");if(void 0!==_.style.animationName&&(f=!0),!1===f)for(var m=0;m<h.length;m++)if(void 0!==_.style[h[m]+"AnimationName"]){p="-"+h[m].toLowerCase()+"-",n=g[m],f=!0;break}t="@"+p+"keyframes "+(r="resizeanim")+" { from { opacity: 0; } to { opacity: 0; } } ",a=p+"animation: 1ms "+r+"; "}return{addResizeListener:function(i,c){if(l)i.attachEvent("onresize",c);else{if(!i.__resizeTriggers__){var d=i.ownerDocument,f=u.getComputedStyle(i);f&&"static"===f.position&&(i.style.position="relative"),function(r){if(!r.getElementById("detectElementResize")){var n=(t||"")+".resize-triggers { "+(a||"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; z-index: -1; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',i=r.head||r.getElementsByTagName("head")[0],o=r.createElement("style");o.id="detectElementResize",o.type="text/css",null!=e&&o.setAttribute("nonce",e),o.styleSheet?o.styleSheet.cssText=n:o.appendChild(r.createTextNode(n)),i.appendChild(o)}}(d),i.__resizeLast__={},i.__resizeListeners__=[],(i.__resizeTriggers__=d.createElement("div")).className="resize-triggers";var p=d.createElement("div");p.className="expand-trigger",p.appendChild(d.createElement("div"));var h=d.createElement("div");h.className="contract-trigger",i.__resizeTriggers__.appendChild(p),i.__resizeTriggers__.appendChild(h),i.appendChild(i.__resizeTriggers__),o(i),i.addEventListener("scroll",s,!0),n&&(i.__resizeTriggers__.__animationListener__=function(e){e.animationName===r&&o(i)},i.__resizeTriggers__.addEventListener(n,i.__resizeTriggers__.__animationListener__))}i.__resizeListeners__.push(c)}},removeResizeListener:function(e,t){if(l)e.detachEvent("onresize",t);else if(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(t),1),!e.__resizeListeners__.length){e.removeEventListener("scroll",s,!0),e.__resizeTriggers__.__animationListener__&&(e.__resizeTriggers__.removeEventListener(n,e.__resizeTriggers__.__animationListener__),e.__resizeTriggers__.__animationListener__=null);try{e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)}catch(e){}}}}}null==h||null==g?(c=f,d=function(e){return p(e,20)}):(c=function(e){var t=l(e,2),r=t[0],n=t[1];h(r),f(n)},d=function(e){var t=g((function(){f(r),e()})),r=p((function(){h(t),e()}),20);return[t,r]});var m=function(e){function t(){var e,r,n;a(this,t);for(var i=arguments.length,o=Array(i),l=0;l<i;l++)o[l]=arguments[l];return r=n=s(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o))),n.state={height:n.props.defaultHeight||0,width:n.props.defaultWidth||0},n._onResize=function(){var e=n.props,t=e.disableHeight,r=e.disableWidth,a=e.onResize;if(n._parentNode){var i=n._parentNode.offsetHeight||0,o=n._parentNode.offsetWidth||0,s=window.getComputedStyle(n._parentNode)||{},l=parseInt(s.paddingLeft,10)||0,u=parseInt(s.paddingRight,10)||0,c=parseInt(s.paddingTop,10)||0,d=parseInt(s.paddingBottom,10)||0,f=i-c-d,p=o-l-u;(!t&&n.state.height!==f||!r&&n.state.width!==p)&&(n.setState({height:i-c-d,width:o-l-u}),a({height:i,width:o}))}},n._setRef=function(e){n._autoSizer=e},s(n,r)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),i(t,[{key:"componentDidMount",value:function(){var e=this.props.nonce;this._autoSizer&&this._autoSizer.parentNode&&this._autoSizer.parentNode.ownerDocument&&this._autoSizer.parentNode.ownerDocument.defaultView&&this._autoSizer.parentNode instanceof this._autoSizer.parentNode.ownerDocument.defaultView.HTMLElement&&(this._parentNode=this._autoSizer.parentNode,this._detectElementResize=_(e),this._detectElementResize.addResizeListener(this._parentNode,this._onResize),this._onResize())}},{key:"componentWillUnmount",value:function(){this._detectElementResize&&this._parentNode&&this._detectElementResize.removeResizeListener(this._parentNode,this._onResize)}},{key:"render",value:function(){var e=this.props,t=e.children,r=e.className,a=e.disableHeight,i=e.disableWidth,s=e.style,l=this.state,u=l.height,c=l.width,d={overflow:"visible"},f={},p=!1;return a||(0===u&&(p=!0),d.height=0,f.height=u),i||(0===c&&(p=!0),d.width=0,f.width=c),Object(n.createElement)("div",{className:r,ref:this._setRef,style:o({},d,s)},!p&&t(f))}}]),t}(n.PureComponent);m.defaultProps={onResize:function(){},disableHeight:!1,disableWidth:!1,style:{}},t.a=m}).call(this,r(6))},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){"use strict";r.r(t);var n=r(3),a=r(1),i=r(0),o=r.n(i),s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var l=function(){return(l=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function u(e,t,r,n){return new(r||(r=Promise))((function(a,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}l((n=n.apply(e,t||[])).next())}))}function c(e,t){var r,n,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&i[0]?n.return:i[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],n=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function d(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o}var f=r(4),p=r(5),h=r(2),g=["adhoc","constant","custom","interval","query","textbox"],_=function(e){function t(t){var r=e.call(this,t)||this;return r.annotations={},r.url=void 0===t.url?"":t.url,r.withCredentials=void 0!==t.withCredentials,r.headers={"Content-Type":"application/json"},"string"==typeof t.basicAuth&&t.basicAuth.length>0&&(r.headers.Authorization=t.basicAuth),r}return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.query=function(e){var t=this.processTargets(e);return 0===t.targets.length?Promise.resolve({data:[]}):(t.adhocFilters=Object(h.getTemplateSrv)().getAdhocFilters(this.name),e.scopedVars=l(l({},this.getVariables()),e.scopedVars),this.doRequest({url:this.url+"/query",data:t,method:"POST"}).then((function(e){return e.data=e.data.map(n.toDataFrame),e})))},t.prototype.testDatasource=function(){var e,t,r;return u(this,void 0,void 0,(function(){var n,a,i,o;return c(this,(function(s){switch(s.label){case 0:n="Data source is not working",s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.doRequest({url:this.url,method:"GET"})];case 2:return 200===(a=s.sent()).status?[2,{status:"success",message:"Data source is working",title:"Success"}]:[2,{message:a.statusText?a.statusText:n,status:"error",title:"Error"}];case 3:return"string"==typeof(i=s.sent())?[2,{status:"error",message:i}]:(o=null!==(e=i.statusText)&&void 0!==e?e:n,void 0!==(null===(r=null===(t=i.data)||void 0===t?void 0:t.error)||void 0===r?void 0:r.code)&&(o+=": "+i.data.error.code+". "+i.data.error.message),[2,{status:"error",message:o,title:"Error"}]);case 4:return[2]}}))}))},t.prototype.metricFindQuery=function(e,t,r){var n="json"===e.format?JSON.parse(Object(h.getTemplateSrv)().replace(e.query,void 0,"json")):{type:r,target:Object(h.getTemplateSrv)().replace(e.query,void 0,"regex")};return this.doRequest({url:this.url+"/search",data:n,method:"POST"}).then(this.mapToTextValue)},t.prototype.getTagKeys=function(e){var t=this;return new Promise((function(r){t.doRequest({url:t.url+"/tag-keys",method:"POST",data:e}).then((function(e){return r(e.data)}))}))},t.prototype.getTagValues=function(e){var t=this;return new Promise((function(r){t.doRequest({url:t.url+"/tag-values",method:"POST",data:e}).then((function(e){return r(e.data)}))}))},t.prototype.annotationQuery=function(e){var t={annotation:{query:Object(h.getTemplateSrv)().replace(e.annotation.query,{},"glob"),name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor},range:e.range,rangeRaw:e.rangeRaw,variables:this.getVariables()};return this.doRequest({url:this.url+"/annotations",method:"POST",data:t}).then((function(e){return e.data}))},t.prototype.mapToTextValue=function(e){return e.data.map((function(e,t){return e&&e.text&&e.value?{text:e.text,value:e.value}:Object(f.isObject)(e)?{text:e,value:t}:{text:e,value:e}}))},t.prototype.doRequest=function(e){return e.withCredentials=this.withCredentials,e.headers=this.headers,Object(h.getBackendSrv)().datasourceRequest(e)},t.prototype.processTargets=function(e){var t=this;return e.targets=e.targets.filter((function(e){return void 0!==e.target})).map((function(r){return""!==r.payload.trim()&&("string"==typeof r.payload&&(r.payload=r.payload.replace(Object(h.getTemplateSrv)().regex,(function(r){return t.cleanMatch(r,e)}))),r.payload=JSON.parse(r.payload)),"string"==typeof r.target&&(r.target=Object(h.getTemplateSrv)().replace(r.target.toString(),e.scopedVars,"regex")),r})),e},t.prototype.cleanMatch=function(e,t){var r=Object(h.getTemplateSrv)().replace(e,t.scopedVars,"json");return"string"==typeof r&&'"'===r[0]&&'"'===r[r.length-1]?JSON.parse(r):r},t.prototype.getVariables=function(){var e={};return Object.values(Object(h.getTemplateSrv)().getVariables()).forEach((function(t){if(g.includes(t.type)&&"adhoc"!==t.type){var r=t,n=r.current.value;("$__all"===n||Object(f.isEqual)(n,["$__all"]))&&(n=null===r.allValue||""===r.allValue?r.options.slice(1).map((function(e){return e.value})):r.allValue),e[r.id]={text:r.current.text,value:n}}})),e},t}(n.DataSourceApi);r.d(t,"plugin",(function(){return m}));var m=new n.DataSourcePlugin(_).setConfigEditor((function(e){var t=e.options,r=e.onOptionsChange;return o.a.createElement(o.a.Fragment,null,o.a.createElement(a.DataSourceHttpSettings,{defaultUrl:"http://localhost:8080",dataSourceConfig:t,showAccessOptions:!0,onChange:r}))})).setQueryEditor((function(e){var t,r=e.datasource,n=e.onChange,i=e.onRunQuery,s=e.query,u=d(o.a.useState(),2),c=u[0],h=u[1],g=d(o.a.useState(null!==(t=s.payload)&&void 0!==t?t:""),2),_=g[0],m=g[1],v=d(o.a.useState(null),2),y=v[0],b=v[1],w=d(o.a.useState([]),2),S=w[0],z=w[1],O=d(o.a.useState(!1),2),E=O[0],T=O[1],x=o.a.useCallback((function(){return r.metricFindQuery({query:"",format:"string"},void 0).then((function(e){var t=e.map((function(e){return{label:e.text,value:e.value}})),r=Object(f.find)(t,(function(e){return e.value===s.target}));return h(void 0===r?{label:"",value:""}:r),t}),(function(e){throw h({label:"",value:""}),z([]),new Error(e.statusText)}))}),[r,s.target]),j=o.a.useCallback((function(){T(!0),x().then((function(e){z(e)})).finally((function(){T(!1)}))}),[x,z,T]);return o.a.useEffect((function(){return j()}),[]),o.a.useEffect((function(){void 0!==(null==c?void 0:c.value)&&""!==(null==c?void 0:c.value)&&(null!==y&&(null==c?void 0:c.value)===y.metric&&_===y.payload||(b({payload:_,metric:c.value}),n(l(l({},s),{payload:_,target:c.value})),i()))}),[_,c]),o.a.createElement(o.a.Fragment,null,o.a.createElement(a.InlineFieldRow,null,o.a.createElement(a.InlineField,null,o.a.createElement(a.Select,{isLoading:E,prefix:"Metric: ",options:S,placeholder:"Select metric",allowCustomValue:!0,value:c,onChange:function(e){h(e)}}))),o.a.createElement(a.InlineFieldRow,null,o.a.createElement(p.a,{disableHeight:!0},(function(e){var t=e.width;return o.a.createElement("div",{style:{width:t+"px"}},o.a.createElement(a.InlineLabel,null,"Payload"),o.a.createElement(a.CodeEditor,{width:"100%",height:"200px",language:"json",showLineNumbers:!0,showMiniMap:_.length>100,value:_,onBlur:function(e){return m(e)}}))}))))})).setVariableQueryEditor((function(e){var t,r=e.onChange,n=e.query,s=d(Object(i.useState)(n),2),u=s[0],c=s[1],f=function(){r(u,u.query+("json"===u.format?" (JSON)":""))};return o.a.createElement(o.a.Fragment,null,o.a.createElement(a.InlineFieldRow,null,o.a.createElement(a.InlineField,{label:"Query",invalid:function(e){if("json"===u.format){var t=Object(h.getTemplateSrv)().replace(u.query,void 0,"json");try{JSON.parse(t)}catch(e){if("SyntaxError"===e.name)return!0;throw e}}return!1}(),grow:!0},o.a.createElement(a.Input,{name:"query",onBlur:f,onChange:function(e){var t;return c(l(l({},u),((t={})[e.currentTarget.name]=e.currentTarget.value,t)))},value:u.query})),o.a.createElement(a.InlineField,{labelWidth:14,label:"Raw JSON",tooltip:"When enabled, the query string is parsed as a JSON object. Otherwise when disabled, the query string is placed into a 'target' key to create a JSON object."},o.a.createElement(a.InlineSwitch,{name:"format",onBlur:f,onChange:function(e){var t;return c(l(l({},u),((t={})[e.currentTarget.name]=!0===e.currentTarget.checked?"json":"string",t)))},value:(t=u.format,"json"===t)}))))}))}])}));
//# sourceMappingURL=module.js.map